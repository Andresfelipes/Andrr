@model Proyecto.Models.viewModelEntradas
@{
    ViewBag.Title = "Create";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<header class="page-header">
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-12">
                <h1 class="page-header-heading"><span class="typcn typcn-clipboard page-header-heading-icon"></span>ENTRADAS</h1>
            </div>
        </div>
    </div>
</header>
<br />
<script>
    var res = "@ViewBag.res";

    if (res == "Correcto") {
        swal({ title: "¡REGISTRO EXITOSO!", text: "Entrada registrada correctamente", type: "success", showConfirmButton: true }, function () { location.href = '/Entradas/Index' });
    }
</script>



@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div class="container-fluid">
        <div class="col-md-12">
            <div class="widget widget-default">
                <div class="widget-header">Registrar entrada</div>
                <div class="widget-body">

                    <div class="form">
                        <hr />
                        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                        <div class="form-group col-md-6">
                            <label class="control-label col-md-2" for="cod">Código *</label>
                            @Html.EditorFor(model => model.Tb_Entradas.Codigo, new { htmlAttributes = new { @class = "form-control validate-character" } })
                        </div>
                        <div class="form-group col-md-6">
                            <label class="control-label col-md-2" for="Fecha">Fecha *</label>

                            <input class="form-control text-box single-line" data-val="true" data-val-date="The field Fecha must be a date." data-val-required="El campo Fecha es obligatorio." id="Fecha" name="Fecha" type="date" value="">
                            <span class="field-validation-valid text-danger" data-valmsg-for="Fecha" data-valmsg-replace="true"></span>

                        </div>

                        <div class="form-group col-md-6">
                            <label id="lblid" class="control-label" Text="estado">Estado *</label>
                            <select class="form-control" id="Estado" name="Estado" , disabled="disabled">
                                <option value="Activa">Activo</option>
                                <option value="Anulada">Anulado</option>
                            </select>
                            @Html.ValidationMessageFor(model => model.Tb_Entradas.Estado, "", new { @class = "text-danger" })
                        </div>

                        <div class="form-group col-md-6">
                            <label id="lblid" class="control-label" Text="tot">Total</label>
                            @Html.EditorFor(model => model.Tb_Entradas.Total, new { htmlAttributes = new { @class = "form-control"} })
                            @Html.ValidationMessageFor(model => model.Tb_Entradas.Total, "", new { @class = "text-danger" })

                        </div>

                        <div class="form-group col-md-6">
                            <label id="lblid" class="control-label" Text="sucur">Sucursal *</label>
                            @Html.DropDownList("Sucursal", null, htmlAttributes: new { @class = "form-control" })
                            @Html.ValidationMessageFor(model => model.Tb_Entradas.Sucursal, "", new { @class = "text-danger" })

                        </div>

                        <div class="form-group col-md-6">
                            <label id="lblid" class="control-label" Text="prov">Proveedor *</label>
                            <select class="selectpicker form-control selectcliente" data-live-search="true" id="Proveedor" name="Proveedor" tabindex="-98">
                                <option value="0">Seleccione un Proveedor...</option>
                                @foreach (var item in ViewBag.Prove)
                                {
                                    <option value="@item.Identificacion" data-subtext="@item.Identificacion">@item.Nombre1</option>
                                }
                            </select>

                            @Html.ValidationMessageFor(model => model.Tb_Entradas.Proveedor, "", new { @class = "text-danger" })

                        </div>
                        <div class="widget-body" style="width: 962px; padding-left: 3px; margin-right: 900px;">
                            <table class="table ">
                                <thead>
                                    <tr>

                                        <th>Producto Sucursal</th>
                                        <th style="width: 250px; padding-left: 15px;">Cantidad</th>
                                        <th>Precio</th>
                                        <th class="text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <div class="form-group">
                                                <div class="col-md-10">

                                                    <select class="selectpicker form-control selectcliente" data-live-search="true" id="Producto" name="Producto" tabindex="-98">
                                                        <option value="0">Seleccione un Producto...</option>
                                                        @foreach (var item in ViewBag.dato)
                                                        {
                                                            <option value="@item.Codigo_producto" data-subtext="@item.Codigo_producto">@item.Descripcion</option>
                                                        }
                                                    </select>
                                                    @Html.ValidationMessageFor(model => model.Tb_Detalle.ProductoSucursal, "", new { @class = "text-danger" })
                                                </div>
                                            </div>
                                        </td>
                                        <td style="width: 250px;">
                                            <div class="form-group">
                                                <div class="col-md-10">
                                                    @Html.EditorFor(model => model.Tb_Detalle.Cantidad, new { htmlAttributes = new { @class = "form-control validate-character" } })
                                                    @Html.ValidationMessageFor(model => model.Tb_Detalle.Cantidad, "", new { @class = "text-danger" })
                                                </div>
                                            </div>
                                        </td>

                                        <td style="width: 250px;">
                                            <div class="col-md-10">
                                                @Html.EditorFor(model => model.Tb_Detalle.Precio, new { htmlAttributes = new { @class = "form-control validate-character" } })
                                                @Html.ValidationMessageFor(model => model.Tb_Detalle.Precio, "", new { @class = "text-danger" })
                                            </div>
                                        </td>


                                        <td class="text-right"><input onclick="pasarDetalle()" value="Agregar" type="button" class="btn btn-primary" style="background-color:limegreen; color:white; border-color:limegreen;"></td>
                                    </tr>
                                </tbody>
                                <tbody id="Detalle"></tbody>
                            </table>
                        </div>

                        <div id="Hola">
                        </div>
                        <div class="form-group ">
                            <div class="col-md-offset-5 col-md-6 col-lg-6">
                                <input onclick="registrar_Detalle_Entrada()" type="button" value="Registrar" class="btn btn-primary" />
                                <input onclick="calcularTotalDetalle()" type="button" value="Validar" class="btn btn-default" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



}




<script type="text/javascript">
    window.onload = function () {
        $('#Estado').attr("disabled", "disabled");
        $('#Sucursal').attr("disabled", "disabled");
        $('#Tb_Entradas_Total').attr("disabled", "disabled");
    }
    var array = { detalle: [], fecha:'', total: '', estado : '', sucursal : '', proveedor : ''  };
    function pasarDetalle() {
        if ($('#Producto').val() != 0) {
            if ($('#Tb_Detalle_Cantidad').val() != "") {
                if ($('#Tb_Detalle_Cantidad').val() >= 1) {
                    if ($('#Tb_Detalle_Precio').val() != "") {
                        var actu = 0;
                        var producto_cod = $('#Producto').val();
                        for (var i = 0; i < array.detalle.length; i++) {
                            if (array.detalle[i].ProductoSucursal == producto_cod) {
                                actu = 1;
                            }
                        }
                        if (actu == 0) {
                            var produ = $('#Producto').val();
                            var canti = $('#Tb_Detalle_Cantidad').val();
                            var pre = $('#Tb_Detalle_Precio').val();
                            var html = '';
                            html += '<tr id="Hola">';
                            html += '<td style="width: 250px;padding-left: 22px;">';
                            html += '<div class="col-md-10" style="padding-left: 0px;">';
                            html += '<label>' + produ + '</label>';
                            html += '</div>';
                            html += '</td>';
                            html += '<td style="width: 250px;padding-left: 20px;">';
                            html += '<div class="col-md-10" style="padding-left: 0px;">';
                            html += '<label>' + canti + '</label>';
                            html += '</div>';
                            html += '</td>';
                            html += '<td style="width: 250px;padding-left: 20px;">';
                            html += '<div class="col-md-10" style="padding-left: 0px;">';
                            html += '<label id="Precio">' + pre + '</label>';
                            html += '</div>';
                            html += '</td>';
                            html += '<td style="width: 250px;>';
                            html += '<div class="col-md-10" style="padding-left: 0px;">';
                            html += '<a onclick="quitarElemento(this)" class="btn btn-danger pull-right"><i class="fa fa-times"></i></a>';
                            html += '</div>';
                            html += '</td>';
                            html += '</tr>';
                            array.detalle.push({ 'ProductoSucursal': produ, 'Cantidad': canti, 'Precio': pre });
                            console.log(produ, canti, pre);
                            $('#Detalle').append(html);
                            $('#Producto').val(0);
                            $('#Tb_Detalle_Cantidad').val('');
                            $('#Tb_Detalle_Precio').val('');
                            calcular();
                        } else {
                            actualizar();
                        }
                    } else {
                        alertify.error("Debe ingresar un precio");
                        $('#Tb_Detalle_Precio').focus();
                    }
                } else {
                    alertify.error("Cantidad debe ser mayor a 0");
                    $('#Tb_Detalle_Cantidad').focus();
                }
            } else {
                alertify.error("Debe ingresar la cantidad");
                $('#Tb_Detalle_Cantidad').focus();
            }
        } else {
            alertify.error("Debe seleccionar un producto");
            $('#Producto').focus();
        }
    }

    function actualizar() {
        var producto_cod = $('#Producto').val();
        var cantidad = $('#Tb_Detalle_Cantidad').val();
        var precio = $('#Tb_Detalle_Precio').val();
        var posi = 0;
        $("#Hola").remove();
        for (var i = 0; i < array.detalle.length; i++) {
            if (array.detalle[i].ProductoSucursal == producto_cod) {
                posi = i;
            }
        }
        array.detalle[posi].Cantidad = (parseFloat(array.detalle[posi].Cantidad) + parseFloat(cantidad));
        array.detalle[posi].Precio = ((parseFloat(array.detalle[posi].Precio) + parseFloat(precio)) / 2);
        for (var i = 0; i < array.detalle.length; i++) {
            var html = '';
            html += '<tr id="Hola">';
            html += '<td style="width: 250px;padding-left: 20px;">';
            html += array.detalle[i].ProductoSucursal;
            html += '</td>';
            html += '<td style="width: 250px;padding-left: 20px;">';
            html += '<div class="col-md-10" style="padding-left: 0px;">';
            html += '<label>' + array.detalle[i].Cantidad + '</label>';
            html += '</div>';
            html += '</td>';
            html += '<td style="width: 250px;padding-left: 20px;">';
            html += '<div class="col-md-10" style="padding-left: 0px;">';
            html += '<label id="Pre">' + array.detalle[i].Precio + '</label>';
            html += '</div>';
            html += '</td>';
            html += '<td style="width: 250px;>';
            html += '<div class="col-md-10" style="padding-left: 0px;">';
            html += '<a onclick="quitarElemento(this)" class="btn btn-danger pull-right"><i class="fa fa-times"></i></a>';
            html += '</div>';
            html += '</td>';
            html += '</tr>';
            $('#Detalle').append(html);
            calcular();
        }
        $('#Producto').val(0);
        $('#Tb_Detalle_Cantidad').val('');
        $('#Tb_Detalle_Precio').val('');
    }

    function quitarElemento(elemento) {
        var e = $(elemento).parent().parent();
        $(e).remove();
        var valores = "";
        $(elemento).parents("tr").find("td").each(function () {
            valores += $(this).html() + "\n";
            return false;
        });
        $("#Producto").val(valores);
        valor = $("#Producto").val();
        $("#Producto").val('');
        for (var i = 0; i < array.detalle.length; i++) {
            if (array.detalle[i].ProductoSucursal == valor) {
                var arrays = { detalle: [], venta: '', sub_total: '', fecha: '', sucursal: '', cliente: '', iva: '', total: '' };
                arrays.detalle = array.detalle;
                array = { detalle: [], venta: '', sub_total: '', fecha: '', sucursal: '', cliente: '', iva: '', total: '' };
                for (var i = 0; i < arrays.detalle.length; i++) {
                    if (arrays.detalle[i].ProductoSucursal != valor) {
                        array.detalle[i] = arrays.detalle[i];
                    }
                }
            }
        }
        calcular();

    }

    function registrar_Detalle_Entrada() {
        if ((($("#Tb_Entradas_Codigo").val() != "") || ($("#Proveedor").val() != 0)) || (($("#Fecha").val() != "") || (array.detalle.length != 0))) {
            if ($("#Tb_Entradas_Codigo").val() != "") {
                if ($("#Fecha").val() != "") {
                    if ($("#Proveedor").val() != 0) {
                        if (array.detalle.length != 0) {
                            $('#Estado').removeAttr("disabled");
                            $('#Sucursal').removeAttr("disabled");
                            $('#Tb_Entradas_Total').removeAttr("disabled");
                            array.entrada = $("#Tb_Entradas_Codigo").val();
                            array.fecha = $("#Fecha").val();
                            array.proveedor = $("#Proveedor").val();
                            array.sucursal = $("#Sucursal").val();
                            array.estado = $("#Estado").val();
                            array.total = $("#Tb_Entradas_Total").val();
                            $.ajax({
                                'url': '/Entradas/crear',
                                'dataType': 'json',
                                'type': 'post',
                                'contentType': "application/json; charset=utf-8",
                                'data': JSON.stringify(array)
                            }).done(function (respuesta) {
                                location.href = '/Entradas/Index';
                            })
                        } else {
                            sweetAlert("¡ERROR!", "Debe diligenciar los campos obligatorios!", "error");
                        }
                    } else {
                        sweetAlert("¡ERROR!", "Debe diligenciar los campos obligatorios!", "error");
                    }
                } else {
                    sweetAlert("¡ERROR!", "Debe diligenciar los campos obligatorios!", "error");
                }
            } else {
                sweetAlert("¡ERROR!", "Debe diligenciar los campos obligatorios!", "error");
            }
        } else {
            sweetAlert("¡ERROR!", "Debe diligenciar los campos obligatorios!", "error");
        }
        }

        function calcular() {
            var Total = 0;
            for (var i = 0; i < array.detalle.length; i++) {
                Total += parseFloat(parseFloat(array.detalle[i].Cantidad) * parseFloat(array.detalle[i].Precio));
            }
            var tot = parseFloat(parseFloat(Total));
            $('#Tb_Entradas_Total').val(parseFloat(tot));
        }



</script>
